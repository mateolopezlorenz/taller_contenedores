name: CI/CD Fase 3

#Cuando se sube algo a la rama que especificamos a continuación, se ejecuta el workflow.
on:
  #Especificamos la rama donde se ejecuta a la hora de subir archivos (hacer push).
  push:
    branches: main
  #Especificamos la rama donde se ejecuta a la hora de hacer un pull request.
  pull_request:
    branches: main

#Definimos los jobs que se ejecutarán a la hora de hacer push o pull request.
jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      #Definimos el JDK que vamos a usar
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      #Validar el formato y correctesa del código con Checkstyle
      - name: Checkstyle linting
        working-directory: taller/taller
        run: mvn checkstyle:check

      #Ejecutamos los tests unitarios (usan H2 en memoria, no necesitan MariaDB)
      - name: Run unit tests
        working-directory: taller/taller
        run: mvn test -Dtest="TallerApplicationTests,Tests#testCantidadCoches+testCocheNoNull+testIdsCoche+testMatriculasUnicas+testAddCar+testUpdateCar+testDeleteCar+testAddMecanico+testUpdateMecanico+testDeleteMecanico+testCrearCocheDuplicadoMatricula+testCrearMecanicoDuplicadoNombre"

      #Ejecutamos los tests de integración
      - name: Run integration tests
        working-directory: taller/taller
        run: mvn test -Dtest="Tests#testRelacionCocheReparacion+testRelacionCocheMultipleReparaciones+testAddReparacion+testActualizarReparacion+testEliminarReparacion+testCrearReparacionSinCoche+testCrearReparacionSinMecanico"

      #Ejecutamos los tests de aceptación
      - name: Run acceptance tests
        working-directory: taller/taller
        run: mvn test -Dtest="Tests#testCrearVariasReparaciones+testEliminarCocheConReparaciones+testEliminarMecanicoConReparaciones+testActualizarDescripcionReparacion+testActualizarFechaReparacion+testCrearCocheConMatriculaUnica+testCrearMecanicoNuevo+testCrearReparacionVariasHorasYPrecio+testActualizarTodosLosCamposReparacion+testCantidadCochesDespuesDeAdd+testCantidadMecanicosDespuesDeAdd+testCantidadReparacionesDespuesDeAdd"

      #Si los tests pasan todos correctamente, empaquetamos la aplicación y construimos la imagen
      - name: Package application
        working-directory: taller/taller
        run: mvn clean package -DskipTests

      #Construimos la imagen de docker utilizando el dockerfile
      - name: Build Docker image
        working-directory: taller/taller
        run: docker build -t taller-app .